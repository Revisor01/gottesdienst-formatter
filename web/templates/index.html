{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        
        <!-- ChurchDesk API Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h4 class="mb-0">ChurchDesk API - Gottesdienste abrufen</h4>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Rufen Sie Gottesdienste direkt aus ChurchDesk ab und wählen Sie aus, welche in das Boyens Format exportiert werden sollen.
                </p>
                
                <form method="POST" action="{{ url_for('fetch_churchdesk_events') }}">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="year" class="form-label">Jahr</label>
                                <select name="year" id="year" class="form-control" required>
                                    <option value="2025" selected>2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="month" class="form-label">Monat</label>
                                <select name="month" id="month" class="form-control" required>
                                    <option value="1">Januar</option>
                                    <option value="2">Februar</option>
                                    <option value="3">März</option>
                                    <option value="4">April</option>
                                    <option value="5">Mai</option>
                                    <option value="6">Juni</option>
                                    <option value="7" selected>Juli</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Dezember</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Alle Organisationen</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="select-all-orgs" checked>
                                    <label class="form-check-label" for="select-all-orgs">
                                        Alle auswählen
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Gemeinden auswählen:</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input org-checkbox" type="checkbox" name="selected_organizations" value="2596" id="org-2596" checked>
                                    <label class="form-check-label" for="org-2596">
                                        <strong>Kirchenkreis Dithmarschen</strong><br>
                                        <small class="text-muted">Zentrale Verwaltung</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input org-checkbox" type="checkbox" name="selected_organizations" value="6572" id="org-6572" checked>
                                    <label class="form-check-label" for="org-6572">
                                        <strong>Kirchspiel Heide & Region</strong><br>
                                        <small class="text-muted">Heide (St.-Jürgen, Erlöser, Auferstehung), Nordhastedt, Wesseln, Hemmingstedt</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input org-checkbox" type="checkbox" name="selected_organizations" value="2719" id="org-2719" checked>
                                    <label class="form-check-label" for="org-2719">
                                        <strong>KG Hennstedt & Region</strong><br>
                                        <small class="text-muted">Hennstedt (St. Secundus-Kirche, Kapelle), Kita Lummerland</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input org-checkbox" type="checkbox" name="selected_organizations" value="2729" id="org-2729" checked>
                                    <label class="form-check-label" for="org-2729">
                                        <strong>KG Büsum, Wesselburen, Neuenkirchen</strong><br>
                                        <small class="text-muted">Mehrere Gemeinden der Region</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        <i class="fas fa-cloud-download-alt"></i> Gottesdienste von ChurchDesk abrufen
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Divider -->
        <div class="text-center my-4">
            <h5 class="text-muted">oder</h5>
        </div>
        
        <!-- Excel Upload Section -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Excel-Datei hochladen</h4>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Laden Sie Ihre Excel-Datei mit den Gottesdienstdaten hoch. 
                    Das System konvertiert die Daten automatisch in das von Boyens Medien geforderte Format.
                </p>
                
                <form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data">
                    <div class="file-upload-area">
                        <div class="mb-3">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-success">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10,9 9,9 8,9"></polyline>
                            </svg>
                        </div>
                        <h5>Excel-Datei auswählen</h5>
                        <p class="text-muted">Nur .xlsx Dateien werden unterstützt</p>
                        <input type="file" name="file" accept=".xlsx" class="form-control" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        Datei verarbeiten
                    </button>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Anforderungen</h5>
            </div>
            <div class="card-body">
                <p>Die Excel-Datei muss folgende Spalten enthalten:</p>
                <ul class="list-unstyled">
                    <li><strong>Startdatum:</strong> Datum und Uhrzeit des Gottesdienstes</li>
                    <li><strong>Titel:</strong> Art des Gottesdienstes</li>
                    <li><strong>Standortnamen:</strong> Kirche/Ort</li>
                    <li><strong>Mitwirkender:</strong> Pastor/Pastorin</li>
                    <li><strong>Gemeinden:</strong> Gemeinde (falls Standort leer)</li>
                </ul>
                
                <h6 class="mt-3">Ausgabeformat:</h6>
                <div class="bg-light p-3 rounded">
                    <code>
                        Sonntag, 1. Juni:<br>
                        Albersdorf: 9.30 Uhr, Gd., P. Keppel<br>
                        Büsum: 10 Uhr, Gd. m. A., Pn. Schmidt
                    </code>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Handle organization selection
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all-orgs');
    const orgCheckboxes = document.querySelectorAll('.org-checkbox');
    
    function updateSelectAllState() {
        const checkedCount = document.querySelectorAll('.org-checkbox:checked').length;
        const totalCount = orgCheckboxes.length;
        
        selectAllCheckbox.checked = checkedCount === totalCount;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
    }
    
    // Select all checkbox handler
    selectAllCheckbox.addEventListener('change', function() {
        orgCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // Individual checkbox handlers
    orgCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAllState();
        });
    });
    
    // Initialize state
    updateSelectAllState();
    
    // Set current month as default
    const currentMonth = new Date().getMonth() + 1;
    document.getElementById('month').value = currentMonth;
});
</script>
{% endblock %}